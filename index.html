<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Roguelite Yahtzee</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        :root{
            --accent-1: #ff4d4d;
            --accent-2: #ffec70;
            --accent-3: #ffb347;
            --bg-grad: linear-gradient(135deg, var(--accent-2) 0%, var(--accent-1) 100%);
        }
        html, body {
            height: 100%;
            margin: 0;
            background: var(--bg-grad);
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            color: #fff;
        }

        /* App layout */
        #app {
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            justify-content: center;
            padding: 18px;
            box-sizing: border-box;
        }

        header#header {
            width: 100%;
            max-width: 1100px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            pointer-events: auto;
        }

        .stats {
            display: flex;
            gap: 12px;
            align-items: center;
            color: #fff;
            text-shadow: 2px 2px 0 var(--accent-1), 0 0 8px var(--accent-2);
            font-size: 14px;
            flex-wrap: wrap;
        }

        .stat-pill {
            background: rgba(0,0,0,0.28);
            border: 2px solid rgba(255,255,255,0.08);
            padding: 8px 12px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            pointer-events: auto;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            padding: 8px 14px;
            border-radius: 8px;
            border: 2px solid var(--accent-1);
            cursor: pointer;
            background: var(--accent-2);
            color: var(--accent-1);
            transition: transform .08s ease, filter .12s ease;
        }
        .btn.secondary { background: var(--accent-1); color: #fff; border-color: var(--accent-2); }
        .btn:active { transform: translateY(1px) scale(0.995); }

        /* Canvas area */
        main.main {
            width: 100%;
            flex: 1 1 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .canvas-wrap {
            width: min(92vw, 960px);
            height: auto;
            background: rgba(0,0,0,0.08);
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
        }
        #gameCanvas {
            background: #222;
            border: 10px solid var(--accent-1);
            image-rendering: pixelated;
            box-shadow: 0 0 36px var(--accent-2), 0 0 12px var(--accent-1);
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* Deck UI */
        #deckUI { display:flex; gap:10px; align-items:center; justify-content:center; }
        .deck-slot { display:flex; flex-direction:column; align-items:center; gap:6px; }
        .deck-slot canvas { width:48px; height:48px; image-rendering: pixelated; border-radius:6px; }
        .deck-label { font-size:10px; color:#fff; text-shadow: 1px 1px 0 rgba(0,0,0,0.6); }

        /* Shop as right-side slide panel */
        #shop {
            position: fixed;
            top: 12px;
            right: 12px;
            width: min(360px, 90vw);
            height: calc(100% - 24px);
            background: #fff8e1;
            border: 4px solid var(--accent-1);
            border-radius: 12px;
            padding: 16px;
            display: none; /* controlled by JS */
            z-index: 1200;
            font-family: 'Press Start 2P', cursive;
            color: var(--accent-1);
            box-shadow: 0 8px 40px rgba(0,0,0,0.35);
            overflow: auto;
            transform: translateX(18px);
            transition: transform 280ms ease, opacity 200ms ease;
        }
        #shop.open { transform: translateX(0); }

        .shop-title { font-size: 16px; margin-bottom: 8px; color: var(--accent-1); }
        .shop-list { display: flex; flex-direction: column; gap: 10px; }
        .shop-item {
            margin: 0;
            cursor: pointer;
            background: linear-gradient(180deg,var(--accent-2),#ffe066);
            border: 2px solid var(--accent-1);
            border-radius: 8px;
            padding: 10px;
            transition: transform .12s ease, box-shadow .12s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .shop-item:hover { transform: translateY(-3px); box-shadow: 0 8px 18px rgba(0,0,0,0.12); }
        .shop-icon { width: 26px; height: 26px; }
        #closeShop { margin-top: 12px; }

        .muted { opacity: 0.6; }

        /* Modal */
        #modal {
            position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; z-index:2000; background: rgba(0,0,0,0.5); visibility:hidden; opacity:0; transition:opacity .18s ease, visibility .18s;
        }
        #modal.open { visibility:visible; opacity:1; }
        .modal-card { background:#fff; color:#111; padding:20px; border-radius:12px; border:4px solid var(--accent-1); width: min(90%, 420px); text-align:center; font-family:'Press Start 2P',cursive; }
        .modal-card p { margin:12px 0; }
        .modal-card .btn { margin-top:8px; }

        @media (max-width: 640px) {
            .stats { font-size: 12px; }
            .btn { font-size: 12px; padding: 6px 10px; }
            header#header { padding: 6px; }
            #shop { width: 92vw; left: 50%; right: auto; transform: translateX(50%); top: auto; bottom: 12px; height: auto; }
        }

        /* Left stats and log panel */
        #statsPanel {
            position: fixed;
            left: 12px;
            top: 12px;
            width: 220px;
            max-height: calc(100% - 24px);
            background: rgba(0,0,0,0.36);
            border: 3px solid rgba(255,255,255,0.06);
            padding: 12px;
            border-radius: 10px;
            color: #fff;
            z-index: 1500;
            overflow: auto;
            font-size: 12px;
        }
        #statsPanel h4 { margin: 6px 0; font-size: 12px; }
        .stat-row { display:flex; justify-content:space-between; gap:8px; padding:4px 0; }
        #logList { display:flex; flex-direction:column; gap:6px; margin-top:8px; }
        .log-item { background: rgba(255,255,255,0.06); padding:6px; border-radius:6px; font-size:11px; }

        /* Deck selector popup */
        .deck-selector { position:fixed; z-index:2200; background:#fff8e1; border:3px solid var(--accent-1); padding:8px; border-radius:8px; box-shadow:0 8px 30px rgba(0,0,0,0.3); }
        .deck-selector button { display:block; width:100%; margin:6px 0; text-align:left; }
    </style>
</head>
<body>
    <div id="app">
        <header id="header">
            <div class="stats">
                <div class="stat-pill"><span id="score">Score: 0</span></div>
                <div class="stat-pill"><span id="gold">Gold: 0</span></div>
                <div class="stat-pill"><span id="rerolls">Rerolls: 3</span></div>
                <div class="stat-pill"><span id="deck"></span></div>
                <div class="stat-pill"><span id="round">Round: 1</span></div>
                <div class="stat-pill"><span id="roundScore">Round: 0</span></div>
                <div class="stat-pill"><span id="levelGoal">Goal: 30</span></div>
            </div>
            <div class="controls">
                <button id="rollBtn" class="btn">Roll Dice</button>
                <button id="endRoundBtn" class="btn">End Round</button>
                <button id="shopBtn" class="btn secondary" disabled>Shop</button>
            </div>
        </header>

        <main class="main">
            <div class="canvas-wrap">
                <canvas id="gameCanvas" width="640" height="480"></canvas>
                <div id="deckUI" aria-hidden="false"></div>
            </div>
        </main>

        <aside id="shop" aria-hidden="true">
            <div class="shop-title">Shop</div>
            <div id="shopItems" class="shop-list"></div>
            <button id="closeShop" class="btn">Close</button>
        </aside>
    </div>

    <div id="modal" role="dialog" aria-hidden="true">
        <div class="modal-card">
            <div id="modalMsg">Message</div>
            <p id="modalDetails"></p>
            <button id="modalOk" class="btn">OK</button>
        </div>
    </div>

    <script>
        // --- Pixel Art Dice Sprites ---
        const diceSprites = {
            normal: [
                [ [0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,2,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0] ],
                [ [0,0,0,0,0,0],[0,2,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,2,0],[0,0,0,0,0,0],[0,0,0,0,0,0] ],
                [ [0,0,0,0,0,0],[0,2,0,0,0,0],[0,0,2,0,0,0],[0,0,0,0,2,0],[0,0,0,0,0,0],[0,0,0,0,0,0] ],
                [ [0,2,0,0,2,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,2,0,0,2,0],[0,0,0,0,0,0] ],
                [ [0,2,0,0,2,0],[0,0,0,0,0,0],[0,0,2,0,0,0],[0,0,0,0,0,0],[0,2,0,0,2,0],[0,0,0,0,0,0] ],
                [ [0,2,0,0,2,0],[0,0,0,0,0,0],[0,2,0,0,2,0],[0,0,0,0,0,0],[0,2,0,0,2,0],[0,0,0,0,0,0] ]
            ]
        };

        function makeColoredDice(base, borderColor) {
            return base.map(face => face.map((row, y) =>
                row.map((cell, x) => {
                    if (x === 0 || x === 5 || y === 0 || y === 5) return borderColor;
                    return cell;
                })
            ));
        }
        diceSprites.fire = makeColoredDice(diceSprites.normal, 3);
        diceSprites.lucky = makeColoredDice(diceSprites.normal, 4);
        diceSprites.shield = makeColoredDice(diceSprites.normal, 5);
        diceSprites.frost = makeColoredDice(diceSprites.normal, 6);
        diceSprites.poison = makeColoredDice(diceSprites.normal, 7);
        diceSprites.gold = makeColoredDice(diceSprites.normal, 8);
        diceSprites.double = makeColoredDice(diceSprites.normal, 9);

        // --- Dice Definitions ---
        const diceTypes = [
            { name: "Normal Die", key: "normal", desc: "Standard die.", color: "#fff", unlock: 0,
              ability: (rolls, idx, state) => rolls[idx] },
            { name: "Fire Die", key: "fire", desc: "+2 bonus on 6.", color: "#ff4d4d", unlock: 10,
              ability: (rolls, idx, state) => { if (rolls[idx] === 6) state.bonus += 2; return rolls[idx]; } },
            { name: "Lucky Die", key: "lucky", desc: "Rerolls 1s.", color: "#ffec70", unlock: 20,
              ability: (rolls, idx, state) => { if (rolls[idx] === 1) return Math.floor(Math.random()*6)+1; return rolls[idx]; } },
            { name: "Shield Die", key: "shield", desc: "Blocks negative effects.", color: "#ffb347", unlock: 30,
              ability: (rolls, idx, state) => rolls[idx] },
            { name: "Frost Die", key: "frost", desc: "+3 bonus on 5 or 6.", color: "#8fd8ff", unlock: 12,
              ability: (rolls, idx, state) => { if (rolls[idx] >= 5) state.bonus += 3; return rolls[idx]; } },
            { name: "Poison Die", key: "poison", desc: "Rolling a 1 subtracts 2 score.", color: "#7a1f1f", unlock: 18,
              ability: (rolls, idx, state) => { if (rolls[idx] === 1) state.score = Math.max(0, state.score - 2); return rolls[idx]; } },
            { name: "Gold Die", key: "gold", desc: "5-6 yield extra gold.", color: "#ffd24d", unlock: 8,
              ability: (rolls, idx, state) => { if (rolls[idx] >= 5) state.gold += 1; return rolls[idx]; } },
            { name: "Double Die", key: "double", desc: "Even rolls are doubled.", color: "#ff9fba", unlock: 22,
              ability: (rolls, idx, state) => { if (rolls[idx] % 2 === 0) return rolls[idx] * 2 > 6 ? 6 : rolls[idx] * 2; return rolls[idx]; } },
        ];

        // --- Game State ---
        const INITIAL_LEVEL_GOAL = 30; // starting goal for round 1
        const WIN_LEVEL = 8; // reach this level to win overall
        let state = {
            score: 0,
            gold: 0,
            baseRerolls: 3,
            rerolls: 3,
            deck: [{type: "normal"}, {type: "normal"}, {type: "normal"}, {type: "normal"}, {type: "normal"}],
            unlocked: ["normal"],
            shopOpen: false,
            bonus: 0,
            anim: null,
            diceResults: [],
            round: 1,
            roundActive: true,
            roundScore: 0,
            levelGoal: INITIAL_LEVEL_GOAL,
            upgrades: [],
            winLevel: WIN_LEVEL,
        };

        // --- Canvas Setup (responsive with crisp pixel scaling) ---
        function resizeCanvas() {
            const wrap = document.querySelector('.canvas-wrap');
            const styleW = Math.min(960, window.innerWidth * 0.92);
            const styleH = Math.min(720, window.innerHeight * 0.66);
            const devicePixelRatio = window.devicePixelRatio || 1;
            canvas.style.width = styleW + 'px';
            canvas.style.height = styleH + 'px';
            canvas.width = Math.floor(styleW * devicePixelRatio);
            canvas.height = Math.floor(styleH * devicePixelRatio);
            ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- Stats Panel & Log ---
        function ensureStatsPanel(){
            if (document.getElementById('statsPanel')) return;
            const sp = document.createElement('div');
            sp.id = 'statsPanel';
            sp.innerHTML = `<h4>Stats</h4>
                <div class='stat-row'><div>Score</div><div id='statScore'>0</div></div>
                <div class='stat-row'><div>Gold</div><div id='statGold'>0</div></div>
                <div class='stat-row'><div>Round</div><div id='statRound'>1</div></div>
                <div class='stat-row'><div>Rerolls</div><div id='statRerolls'>3</div></div>
                <h4>Log</h4><div id='logList'></div>`;
            document.body.appendChild(sp);
        }
        ensureStatsPanel();

        function logEvent(text){
            const list = document.getElementById('logList');
            const el = document.createElement('div');
            el.className = 'log-item';
            el.textContent = `${new Date().toLocaleTimeString()}: ${text}`;
            list.insertBefore(el, list.firstChild);
            // keep recent 20
            while(list.children.length>20) list.removeChild(list.lastChild);
        }

        // Update stats panel values
        function updateStatsPanel(){
            document.getElementById('statScore').textContent = state.score;
            document.getElementById('statGold').textContent = state.gold;
            document.getElementById('statRound').textContent = state.round;
            document.getElementById('statRerolls').textContent = state.rerolls;
        }

        // --- Deck Selector (popup) ---
        function openDeckSelector(slotIndex, anchorEl){
            // remove old
            const prev = document.querySelector('.deck-selector'); if(prev) prev.remove();
            const sel = document.createElement('div');
            sel.className = 'deck-selector';
            diceTypes.forEach(dt => {
                if (!state.unlocked.includes(dt.key)) return;
                const btn = document.createElement('button');
                btn.textContent = `${dt.name} (${dt.key})`;
                btn.onclick = () => { state.deck[slotIndex].type = dt.key; updateUI(); sel.remove(); logEvent(`Equipped ${dt.name} in slot ${slotIndex+1}`); };
                sel.appendChild(btn);
            });
            // position near anchor
            const rect = anchorEl.getBoundingClientRect();
            sel.style.left = (rect.right + 8) + 'px';
            sel.style.top = rect.top + 'px';
            document.body.appendChild(sel);
        }

        // --- Mystery Box: shield protection ---
        function applyMysteryBox() {
            const r = Math.random();
            const hasShield = state.deck.some(d=>d.type==='shield');
            if (r < 0.4) {
                state.gold += 5; logEvent('Mystery Box: +5 Gold');
                showModal('Mystery Box', '+5 Gold', null);
            } else if (r < 0.7) {
                state.score += 10; logEvent('Mystery Box: +10 Score');
                showModal('Mystery Box', '+10 Score', null);
            } else {
                if (hasShield) {
                    logEvent('Mystery Box: negative effect blocked by Shield');
                    showModal('Mystery Box', 'Negative effect blocked by Shield die!', null);
                } else {
                    state.score = Math.max(0, state.score - 5);
                    logEvent('Mystery Box: -5 Score');
                    showModal('Mystery Box', '-5 Score', null);
                }
            }
            updateUI();
            updateStatsPanel();
        }

        // Replace original mystery box effect in shopPool
        shopPool.forEach(item => {
            if (item.name === 'Mystery Box') {
                item.effect = applyMysteryBox;
            }
        });

        // Modify renderDeckUI to open selector on click (instead of cycling)
        function renderDeckUI() {
            const container = document.getElementById('deckUI');
            container.innerHTML = '';
            state.deck.forEach((d, i) => {
                const slot = document.createElement('div');
                slot.className = 'deck-slot';
                const c = document.createElement('canvas');
                c.width = 48; c.height = 48;
                const localCtx = c.getContext('2d');
                localCtx.clearRect(0,0,48,48);
                const face = (state.diceResults[i]) ? state.diceResults[i] : 1;
                drawPixelDieTo(localCtx, 2, 2, 44, Math.min(face,6), d.type);
                c.style.border = `2px solid ${ (diceTypes.find(dt=>dt.key===d.type) || {color:'#fff'}).color }`;
                c.style.borderRadius = '6px';
                const label = document.createElement('div');
                label.className = 'deck-label';
                label.textContent = d.type;
                // open selector anchored to the canvas
                slot.onclick = (e) => { openDeckSelector(i, c); };
                slot.appendChild(c);
                slot.appendChild(label);
                container.appendChild(slot);
            });
        }

        // Update updateUI to also update stats panel
        const oldUpdateUI = updateUI;
        updateUI = function(){
            oldUpdateUI();
            updateStatsPanel();
        }

        // ensure log shows purchases and outcomes
        // patch shop open to log outcomes
        const oldOpenShop = openShop;
        openShop = function(){ oldOpenShop(); logEvent('Shop opened'); };

        // patch closeShop to also log results
        const oldCloseShop = closeShop;
        closeShop = function(){
            const prevRound = state.round;
            oldCloseShop();
            if (state.round !== prevRound) logEvent(`Advanced to round ${state.round}. Goal is now ${state.levelGoal}`);
        }

        // --- Pixel Art Dice Sprites ---
        const diceSprites = {
            normal: [
                [ [0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,2,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0] ],
                [ [0,0,0,0,0,0],[0,2,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,2,0],[0,0,0,0,0,0],[0,0,0,0,0,0] ],
                [ [0,0,0,0,0,0],[0,2,0,0,0,0],[0,0,2,0,0,0],[0,0,0,0,2,0],[0,0,0,0,0,0],[0,0,0,0,0,0] ],
                [ [0,2,0,0,2,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,2,0,0,2,0],[0,0,0,0,0,0] ],
                [ [0,2,0,0,2,0],[0,0,0,0,0,0],[0,0,2,0,0,0],[0,0,0,0,0,0],[0,2,0,0,2,0],[0,0,0,0,0,0] ],
                [ [0,2,0,0,2,0],[0,0,0,0,0,0],[0,2,0,0,2,0],[0,0,0,0,0,0],[0,2,0,0,2,0],[0,0,0,0,0,0] ]
            ]
        };

        function makeColoredDice(base, borderColor) {
            return base.map(face => face.map((row, y) =>
                row.map((cell, x) => {
                    if (x === 0 || x === 5 || y === 0 || y === 5) return borderColor;
                    return cell;
                })
            ));
        }
        diceSprites.fire = makeColoredDice(diceSprites.normal, 3);
        diceSprites.lucky = makeColoredDice(diceSprites.normal, 4);
        diceSprites.shield = makeColoredDice(diceSprites.normal, 5);
        diceSprites.frost = makeColoredDice(diceSprites.normal, 6);
        diceSprites.poison = makeColoredDice(diceSprites.normal, 7);
        diceSprites.gold = makeColoredDice(diceSprites.normal, 8);
        diceSprites.double = makeColoredDice(diceSprites.normal, 9);

        // --- Dice Definitions ---
        const diceTypes = [
            { name: "Normal Die", key: "normal", desc: "Standard die.", color: "#fff", unlock: 0,
              ability: (rolls, idx, state) => rolls[idx] },
            { name: "Fire Die", key: "fire", desc: "+2 bonus on 6.", color: "#ff4d4d", unlock: 10,
              ability: (rolls, idx, state) => { if (rolls[idx] === 6) state.bonus += 2; return rolls[idx]; } },
            { name: "Lucky Die", key: "lucky", desc: "Rerolls 1s.", color: "#ffec70", unlock: 20,
              ability: (rolls, idx, state) => { if (rolls[idx] === 1) return Math.floor(Math.random()*6)+1; return rolls[idx]; } },
            { name: "Shield Die", key: "shield", desc: "Blocks negative effects.", color: "#ffb347", unlock: 30,
              ability: (rolls, idx, state) => rolls[idx] },
            { name: "Frost Die", key: "frost", desc: "+3 bonus on 5 or 6.", color: "#8fd8ff", unlock: 12,
              ability: (rolls, idx, state) => { if (rolls[idx] >= 5) state.bonus += 3; return rolls[idx]; } },
            { name: "Poison Die", key: "poison", desc: "Rolling a 1 subtracts 2 score.", color: "#7a1f1f", unlock: 18,
              ability: (rolls, idx, state) => { if (rolls[idx] === 1) state.score = Math.max(0, state.score - 2); return rolls[idx]; } },
            { name: "Gold Die", key: "gold", desc: "5-6 yield extra gold.", color: "#ffd24d", unlock: 8,
              ability: (rolls, idx, state) => { if (rolls[idx] >= 5) state.gold += 1; return rolls[idx]; } },
            { name: "Double Die", key: "double", desc: "Even rolls are doubled.", color: "#ff9fba", unlock: 22,
              ability: (rolls, idx, state) => { if (rolls[idx] % 2 === 0) return rolls[idx] * 2 > 6 ? 6 : rolls[idx] * 2; return rolls[idx]; } },
        ];

        // --- Game State ---
        const INITIAL_LEVEL_GOAL = 30; // starting goal for round 1
        const WIN_LEVEL = 8; // reach this level to win overall
        let state = {
            score: 0,
            gold: 0,
            baseRerolls: 3,
            rerolls: 3,
            deck: [{type: "normal"}, {type: "normal"}, {type: "normal"}, {type: "normal"}, {type: "normal"}],
            unlocked: ["normal"],
            shopOpen: false,
            bonus: 0,
            anim: null,
            diceResults: [],
            round: 1,
            roundActive: true,
            roundScore: 0,
            levelGoal: INITIAL_LEVEL_GOAL,
            upgrades: [],
            winLevel: WIN_LEVEL,
        };

        // --- Canvas Setup (responsive with crisp pixel scaling) ---
        function resizeCanvas() {
            const wrap = document.querySelector('.canvas-wrap');
            const styleW = Math.min(960, window.innerWidth * 0.92);
            const styleH = Math.min(720, window.innerHeight * 0.66);
            const devicePixelRatio = window.devicePixelRatio || 1;
            canvas.style.width = styleW + 'px';
            canvas.style.height = styleH + 'px';
            canvas.width = Math.floor(styleW * devicePixelRatio);
            canvas.height = Math.floor(styleH * devicePixelRatio);
            ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- Stats Panel & Log ---
        function ensureStatsPanel(){
            if (document.getElementById('statsPanel')) return;
            const sp = document.createElement('div');
            sp.id = 'statsPanel';
            sp.innerHTML = `<h4>Stats</h4>
                <div class='stat-row'><div>Score</div><div id='statScore'>0</div></div>
                <div class='stat-row'><div>Gold</div><div id='statGold'>0</div></div>
                <div class='stat-row'><div>Round</div><div id='statRound'>1</div></div>
                <div class='stat-row'><div>Rerolls</div><div id='statRerolls'>3</div></div>
                <h4>Log</h4><div id='logList'></div>`;
            document.body.appendChild(sp);
        }
        ensureStatsPanel();

        function logEvent(text){
            const list = document.getElementById('logList');
            const el = document.createElement('div');
            el.className = 'log-item';
            el.textContent = `${new Date().toLocaleTimeString()}: ${text}`;
            list.insertBefore(el, list.firstChild);
            // keep recent 20
            while(list.children.length>20) list.removeChild(list.lastChild);
        }

        // Update stats panel values
        function updateStatsPanel(){
            document.getElementById('statScore').textContent = state.score;
            document.getElementById('statGold').textContent = state.gold;
            document.getElementById('statRound').textContent = state.round;
            document.getElementById('statRerolls').textContent = state.rerolls;
        }

        // --- Deck Selector (popup) ---
        function openDeckSelector(slotIndex, anchorEl){
            // remove old
            const prev = document.querySelector('.deck-selector'); if(prev) prev.remove();
            const sel = document.createElement('div');
            sel.className = 'deck-selector';
            diceTypes.forEach(dt => {
                if (!state.unlocked.includes(dt.key)) return;
                const btn = document.createElement('button');
                btn.textContent = `${dt.name} (${dt.key})`;
                btn.onclick = () => { state.deck[slotIndex].type = dt.key; updateUI(); sel.remove(); logEvent(`Equipped ${dt.name} in slot ${slotIndex+1}`); };
                sel.appendChild(btn);
            });
            // position near anchor
            const rect = anchorEl.getBoundingClientRect();
            sel.style.left = (rect.right + 8) + 'px';
            sel.style.top = rect.top + 'px';
            document.body.appendChild(sel);
        }

        // --- Mystery Box: shield protection ---
        function applyMysteryBox() {
            const r = Math.random();
            const hasShield = state.deck.some(d=>d.type==='shield');
            if (r < 0.4) {
                state.gold += 5; logEvent('Mystery Box: +5 Gold');
                showModal('Mystery Box', '+5 Gold', null);
            } else if (r < 0.7) {
                state.score += 10; logEvent('Mystery Box: +10 Score');
                showModal('Mystery Box', '+10 Score', null);
            } else {
                if (hasShield) {
                    logEvent('Mystery Box: negative effect blocked by Shield');
                    showModal('Mystery Box', 'Negative effect blocked by Shield die!', null);
                } else {
                    state.score = Math.max(0, state.score - 5);
                    logEvent('Mystery Box: -5 Score');
                    showModal('Mystery Box', '-5 Score', null);
                }
            }
            updateUI();
            updateStatsPanel();
        }

        // Replace original mystery box effect in shopPool
        shopPool.forEach(item => {
            if (item.name === 'Mystery Box') {
                item.effect = applyMysteryBox;
            }
        });

        // Modify renderDeckUI to open selector on click (instead of cycling)
        function renderDeckUI() {
            const container = document.getElementById('deckUI');
            container.innerHTML = '';
            state.deck.forEach((d, i) => {
                const slot = document.createElement('div');
                slot.className = 'deck-slot';
                const c = document.createElement('canvas');
                c.width = 48; c.height = 48;
                const localCtx = c.getContext('2d');
                localCtx.clearRect(0,0,48,48);
                const face = (state.diceResults[i]) ? state.diceResults[i] : 1;
                drawPixelDieTo(localCtx, 2, 2, 44, Math.min(face,6), d.type);
                c.style.border = `2px solid ${ (diceTypes.find(dt=>dt.key===d.type) || {color:'#fff'}).color }`;
                c.style.borderRadius = '6px';
                const label = document.createElement('div');
                label.className = 'deck-label';
                label.textContent = d.type;
                // open selector anchored to the canvas
                slot.onclick = (e) => { openDeckSelector(i, c); };
                slot.appendChild(c);
                slot.appendChild(label);
                container.appendChild(slot);
            });
        }

        // Update updateUI to also update stats panel
        const oldUpdateUI = updateUI;
        updateUI = function(){
            oldUpdateUI();
            updateStatsPanel();
        }

        // ensure log shows purchases and outcomes
        // patch shop open to log outcomes
        const oldOpenShop = openShop;
        openShop = function(){ oldOpenShop(); logEvent('Shop opened'); };

        // patch closeShop to also log results
        const oldCloseShop = closeShop;
        closeShop = function(){
            const prevRound = state.round;
            oldCloseShop();
            if (state.round !== prevRound) logEvent(`Advanced to round ${state.round}. Goal is now ${state.levelGoal}`);
        }

        // --- Reset / Modal ---
        function resetGame() {
            state.score = 0;
            state.gold = 0;
            state.baseRerolls = 3;
            state.rerolls = 3;
            state.deck = [{type: "normal"},{type: "normal"},{type: "normal"},{type: "normal"},{type: "normal"}];
            state.unlocked = ["normal"];
            state.shopOpen = false;
            state.bonus = 0;
            state.anim = null;
            state.diceResults = [];
            state.round = 1;
            state.roundActive = true;
            state.roundScore = 0;
            state.levelGoal = INITIAL_LEVEL_GOAL;
            state.upgrades = [];
            updateUI();
        }

        function showModal(title, details, onOk) {
            const modal = document.getElementById('modal');
            document.getElementById('modalMsg').textContent = title;
            document.getElementById('modalDetails').textContent = details;
            modal.classList.add('open');
            modal.setAttribute('aria-hidden','false');
            const ok = document.getElementById('modalOk');
            function handler(){
                modal.classList.remove('open');
                modal.setAttribute('aria-hidden','true');
                ok.removeEventListener('click', handler);
                if (onOk) onOk();
            }
            ok.addEventListener('click', handler);
        }

        // --- Event Listeners ---
        document.getElementById('rollBtn').onclick = () => {
            if (state.shopOpen) return;
            if (!state.roundActive) return;
            if (state.rerolls > 0) {
                state.rerolls--;
                rollDice();
                updateUI();
                if (state.rerolls <= 0) {
                    // automatically end round
                    state.roundActive = false;
                    updateUI();
                    // enable shop button
                    document.getElementById('shopBtn').disabled = false;
                    document.getElementById('shopBtn').classList.remove('muted');
                    openShop();
                }
            }
        };
        document.getElementById('endRoundBtn').onclick = () => {
            if (!state.roundActive) return;
            state.roundActive = false;
            updateUI();
            openShop();
        };
        document.getElementById('shopBtn').onclick = () => openShop();
        document.getElementById('closeShop').onclick = () => closeShop();

        // --- Initial Draw ---
        function mainLoop() {
            ctx.clearRect(0,0,W,H);
            drawDiceRow(state.diceResults.length ? state.diceResults : [1,1,1,1,1], state.deck, 0);
            requestAnimationFrame(mainLoop);
        }
        updateUI();
        mainLoop();

        // --- Unlock Dice with Score ---
        setInterval(() => {
            diceTypes.forEach(dt => {
                if (state.score >= dt.unlock && !state.unlocked.includes(dt.key)) {
                    state.unlocked.push(dt.key);
                }
            });
        }, 1000);

    </script>
</body>
</html>